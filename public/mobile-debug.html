<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Login Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 500px;
            margin: 0 auto;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }
        button {
            width: 100%;
            padding: 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .error {
            background-color: #ffe6e6;
            border-color: #ff9999;
            color: #cc0000;
        }
        .success {
            background-color: #e6ffe6;
            border-color: #99ff99;
            color: #006600;
        }
        .info {
            background-color: #e6f3ff;
            border-color: #99ccff;
            color: #0066cc;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Mobile Login Debug Tool</h1>
        <p>This tool helps diagnose mobile login issues by testing different aspects of the system.</p>
        
        <div class="form-group">
            <label for="phoneNumber">Phone Number:</label>
            <input type="text" id="phoneNumber" value="9823786415" placeholder="Enter 10-digit phone number" maxlength="10">
        </div>
        
        <button onclick="testEnvironment()">üì± Test Environment Info</button>
        <button onclick="testConnectivity()">üåê Test Network Connectivity</button>
        <button onclick="testCORS()">üîó Test CORS Policy</button>
        <button onclick="testLogin()" id="loginBtn">üîë Test Login API</button>
        <button onclick="clearResults()">üßπ Clear Results</button>
        
        <div id="result" class="result info" style="display: block;">
            <strong>Mobile Debug Tool Ready</strong>
            Device Info: <span id="deviceInfo"></span>
            User Agent: <span id="userAgent"></span>
            Screen Size: <span id="screenSize"></span>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = 'http://192.168.1.3:8000';
        const FRONTEND_BASE = 'http://192.168.1.3:3000';
        
        // Initialize device info
        document.addEventListener('DOMContentLoaded', function() {
            updateDeviceInfo();
        });
        
        function updateDeviceInfo() {
            const deviceInfo = {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                cookieEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine,
                screenWidth: screen.width,
                screenHeight: screen.height,
                windowWidth: window.innerWidth,
                windowHeight: window.innerHeight,
                devicePixelRatio: window.devicePixelRatio
            };
            
            document.getElementById('deviceInfo').textContent = deviceInfo.platform;
            document.getElementById('userAgent').textContent = deviceInfo.userAgent;
            document.getElementById('screenSize').textContent = `${deviceInfo.screenWidth}x${deviceInfo.screenHeight}`;
            
            showResult(`Device Information:\n${JSON.stringify(deviceInfo, null, 2)}`, 'info');
        }
        
        function showResult(content, type = 'info') {
            const resultDiv = document.getElementById('result');
            resultDiv.textContent = content;
            resultDiv.className = `result ${type}`;
            resultDiv.style.display = 'block';
            resultDiv.scrollTop = resultDiv.scrollHeight;
        }
        
        function appendResult(content) {
            const resultDiv = document.getElementById('result');
            resultDiv.textContent += '\n\n' + content;
            resultDiv.scrollTop = resultDiv.scrollHeight;
        }
        
        function clearResults() {
            showResult('Results cleared. Ready for new tests.', 'info');
        }
        
        async function testEnvironment() {
            showResult('Testing Environment...', 'info');
            
            const tests = [
                `Current URL: ${window.location.href}`,
                `API Base URL: ${API_BASE}`,
                `Frontend Base URL: ${FRONTEND_BASE}`,
                `Protocol: ${window.location.protocol}`,
                `Host: ${window.location.host}`,
                `Is HTTPS: ${window.location.protocol === 'https:'}`,
                `Local Storage Available: ${typeof Storage !== 'undefined'}`,
                `Session Storage Available: ${typeof sessionStorage !== 'undefined'}`,
                `Fetch API Available: ${typeof fetch !== 'undefined'}`,
                `Connection Type: ${navigator.connection ? navigator.connection.effectiveType : 'Unknown'}`
            ];
            
            appendResult('Environment Test Results:\n' + tests.join('\n'));
        }
        
        async function testConnectivity() {
            showResult('Testing Network Connectivity...', 'info');
            
            const tests = [
                { name: 'Backend Health Check', url: `${API_BASE}/health` },
                { name: 'Backend Debug Info', url: `${API_BASE}/debug/request-info` },
                { name: 'Google DNS', url: 'https://dns.google/resolve?name=google.com' }
            ];
            
            for (const test of tests) {
                try {
                    appendResult(`\nTesting: ${test.name}`);
                    const startTime = Date.now();
                    const response = await fetch(test.url, { 
                        method: 'GET',
                        mode: 'cors'
                    });
                    const endTime = Date.now();
                    const data = await response.text();
                    
                    appendResult(`‚úÖ ${test.name}: OK (${endTime - startTime}ms)`);
                    if (test.url.includes(API_BASE)) {
                        appendResult(`Response: ${data.substring(0, 200)}...`);
                    }
                } catch (error) {
                    appendResult(`‚ùå ${test.name}: ${error.message}`);
                }
            }
        }
        
        async function testCORS() {
            showResult('Testing CORS Policy...', 'info');
            
            try {
                // Test OPTIONS request (CORS preflight)
                appendResult('Testing CORS preflight request...');
                const optionsResponse = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': window.location.origin,
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type'
                    }
                });
                
                appendResult(`‚úÖ OPTIONS request: ${optionsResponse.status}`);
                
                // Check CORS headers
                const corsHeaders = {
                    'access-control-allow-origin': optionsResponse.headers.get('access-control-allow-origin'),
                    'access-control-allow-methods': optionsResponse.headers.get('access-control-allow-methods'),
                    'access-control-allow-headers': optionsResponse.headers.get('access-control-allow-headers')
                };
                
                appendResult(`CORS Headers:\n${JSON.stringify(corsHeaders, null, 2)}`);
                
            } catch (error) {
                appendResult(`‚ùå CORS test failed: ${error.message}`);
            }
        }
        
        async function testLogin() {
            const phoneNumber = document.getElementById('phoneNumber').value;
            const loginBtn = document.getElementById('loginBtn');
            
            if (!phoneNumber || phoneNumber.length !== 10) {
                showResult('Please enter a valid 10-digit phone number', 'error');
                return;
            }
            
            loginBtn.disabled = true;
            loginBtn.textContent = 'üîÑ Testing Login...';
            
            showResult(`Testing login for phone: ${phoneNumber}`, 'info');
            
            try {
                // Test login request
                appendResult('\n1. Sending login request...');
                const response = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Origin': window.location.origin
                    },
                    body: JSON.stringify({
                        phone_number: phoneNumber
                    })
                });
                
                appendResult(`Login response status: ${response.status}`);
                
                if (response.ok) {
                    const data = await response.json();
                    appendResult(`‚úÖ Login successful!`);
                    appendResult(`User role: ${data.user.role}`);
                    appendResult(`Token length: ${data.access_token.length} chars`);
                    appendResult(`Token preview: ${data.access_token.substring(0, 50)}...`);
                    
                    // Test token verification
                    appendResult('\n2. Testing token verification...');
                    const verifyResponse = await fetch(`${API_BASE}/api/auth/verify-token`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${data.access_token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (verifyResponse.ok) {
                        const verifyData = await verifyResponse.json();
                        appendResult(`‚úÖ Token verification successful`);
                        appendResult(`Verified user: ${verifyData.user.phone_number}`);
                        showResult(document.getElementById('result').textContent, 'success');
                    } else {
                        appendResult(`‚ùå Token verification failed: ${verifyResponse.status}`);
                    }
                    
                } else {
                    const errorText = await response.text();
                    appendResult(`‚ùå Login failed: ${response.status}`);
                    appendResult(`Error response: ${errorText}`);
                    showResult(document.getElementById('result').textContent, 'error');
                }
                
            } catch (error) {
                appendResult(`‚ùå Login error: ${error.message}`);
                appendResult(`Error type: ${error.name}`);
                if (error.stack) {
                    appendResult(`Stack trace: ${error.stack}`);
                }
                showResult(document.getElementById('result').textContent, 'error');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'üîë Test Login API';
            }
        }
        
        // Format phone number input
        document.getElementById('phoneNumber').addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^\d]/g, '');
            if (value.length > 10) {
                value = value.substring(0, 10);
            }
            e.target.value = value;
        });
    </script>
</body>
</html>